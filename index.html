<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Burger Web AR</title>

    <!-- A-Frame and AR.js (pattern marker version) -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }

      .arjs-loader {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .arjs-loader div {
        text-align: center;
        font-size: 1.25em;
        color: white;
      }

      /* Error overlay for camera issues */
      #camera-error {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        color: white;
        z-index: 99999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 20px;
        text-align: center;
        font-family: sans-serif;
      }

      #camera-error h2 {
        color: #ff6b6b;
        margin-bottom: 15px;
      }

      #camera-error p {
        margin: 8px 0;
        font-size: 14px;
        line-height: 1.5;
      }

      #camera-error button {
        margin-top: 20px;
        padding: 12px 30px;
        font-size: 16px;
        background: #ff9900;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <!-- Loading indicator -->
    <div class="arjs-loader">
      <div>Загрузка аппетитного бургера... 🍔<br><small>Разрешите доступ к камере</small></div>
    </div>

    <!-- Camera error overlay -->
    <div id="camera-error">
      <h2>📷 Камера недоступна</h2>
      <p>Для работы AR необходим доступ к камере.</p>
      <p><strong>Возможные причины:</strong></p>
      <p>1. Вы не разрешили доступ к камере</p>
      <p>2. Страница открыта не через HTTPS</p>
      <p>3. Другое приложение использует камеру</p>
      <p><strong>Решение:</strong> Откройте страницу через HTTPS и разрешите доступ к камере.</p>
      <button onclick="location.reload()">Попробовать снова</button>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; colorManagement: true"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">

      <a-assets>
        <a-asset-item id="burger-model" src="models/glb/burger1.glb"></a-asset-item>
      </a-assets>

      <!-- QR Code / Barcode marker (value 6 is commonly used for QR codes) -->
      <a-marker type="barcode" value="6">
        <a-entity
          gltf-model="#burger-model"
          scale="0.5 0.5 0.5"
          position="0 0 0"
          rotation="-90 0 0"
          animation="property: rotation; to: -90 360 0; loop: true; dur: 10000; easing: linear">
        </a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // Camera access check and error handling
      (function() {
        // Check if running on HTTPS or localhost
        var isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        
        if (!isSecure) {
          console.warn('WARNING: Camera access requires HTTPS. Current protocol:', location.protocol);
        }

        // Try to detect camera availability
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
              console.log('Camera access granted!');
              // Stop the test stream - AR.js will request its own
              stream.getTracks().forEach(function(track) { track.stop(); });
            })
            .catch(function(err) {
              console.error('Camera access error:', err.name, err.message);
              document.getElementById('camera-error').style.display = 'flex';
              document.querySelector('.arjs-loader').style.display = 'none';
            });
        } else {
          console.error('getUserMedia not supported');
          document.getElementById('camera-error').style.display = 'flex';
          document.querySelector('.arjs-loader').style.display = 'none';
        }

        // Hide loader when scene is loaded
        var scene = document.querySelector('a-scene');
        if (scene) {
          scene.addEventListener('loaded', function() {
            var loader = document.querySelector('.arjs-loader');
            if (loader) loader.style.display = 'none';
          });
        }
      })();
    </script>
  </body>
</html>
