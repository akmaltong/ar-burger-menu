<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>AR Меню Бургеров - 4 Бургера</title>

  <!-- A-Frame and AR.js (pattern marker version) -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }

    .arjs-loader {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .arjs-loader div {
      text-align: center;
      font-size: 1.25em;
      color: white;
    }

    /* Error overlay for camera issues */
    #camera-error {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      z-index: 99999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
      text-align: center;
      font-family: sans-serif;
    }

    #camera-error h2 {
      color: #ff6b6b;
      margin-bottom: 15px;
    }

    #camera-error p {
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.5;
    }

    #camera-error button {
      margin-top: 20px;
      padding: 12px 30px;
      font-size: 16px;
      background: #ff9900;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Loading indicator -->
  <div class="arjs-loader">
    <div>Загрузка аппетитных бургеров... 🍔🍔🍔🍔<br><small>Разрешите доступ к камере</small></div>
  </div>

  <!-- Camera error overlay -->
  <div id="camera-error">
    <h2>📷 Камера недоступна</h2>
    <p>Для работы AR необходим доступ к камере.</p>
    <p><strong>Возможные причины:</strong></p>
    <p>1. Вы не разрешили доступ к камере</p>
    <p>2. Страница открыта не через HTTPS</p>
    <p>3. Другое приложение использует камеру</p>
    <p><strong>Решение:</strong> Откройте страницу через HTTPS и разрешите доступ к камере.</p>
    <button onclick="location.reload()">Попробовать снова</button>
  </div>

  <a-scene vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true; colorManagement: true" embedded
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">

    <a-assets>
      <a-asset-item id="burger1-model" src="models/glb/burger1.glb"></a-asset-item>
      <a-asset-item id="burger2-model" src="models/glb/burger2.glb"></a-asset-item>
      <a-asset-item id="burger3-model" src="models/glb/burger3.glb"></a-asset-item>
      <a-asset-item id="burger4-model" src="models/glb/burger4.glb"></a-asset-item>
    </a-assets>

    <!-- Burger 1 - HIRO marker -->
    <a-marker preset="hiro">
      <a-entity gltf-model="#burger1-model" scale="0.15 0.15 0.15" position="0 0 0" rotation="-90 0 0"
        animation="property: rotation; to: -90 360 0; loop: true; dur: 10000; easing: linear">
      </a-entity>
    </a-marker>

    <!-- Burger 2 - KANJI marker -->
    <a-marker preset="kanji">
      <a-entity gltf-model="#burger2-model" scale="0.15 0.15 0.15" position="0 0 0" rotation="-90 0 0"
        animation="property: rotation; to: -90 360 0; loop: true; dur: 10000; easing: linear">
      </a-entity>
    </a-marker>

    <!-- Burger 3 - A marker -->
    <a-marker preset="A">
      <a-entity gltf-model="#burger3-model" scale="0.15 0.15 0.15" position="0 0 0" rotation="-90 0 0"
        animation="property: rotation; to: -90 360 0; loop: true; dur: 10000; easing: linear">
      </a-entity>
    </a-marker>

    <!-- Burger 4 - B marker -->
    <a-marker preset="B">
      <a-entity gltf-model="#burger4-model" scale="0.15 0.15 0.15" position="0 0 0" rotation="-90 0 0"
        animation="property: rotation; to: -90 360 0; loop: true; dur: 10000; easing: linear">
      </a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Camera access check and error handling
    (function () {
      // Check if running on HTTPS or localhost
      var isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

      if (!isSecure) {
        console.warn('WARNING: Camera access requires HTTPS. Current protocol:', location.protocol);
        alert('⚠️ Внимание: Для работы камеры необходим HTTPS!\n\nТекущий протокол: ' + location.protocol + '\n\nПожалуйста, откройте страницу через HTTPS.');
      }

      // Try to detect camera availability
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(function (stream) {
            console.log('Camera access granted!');
            // Stop the test stream - AR.js will request its own
            stream.getTracks().forEach(function (track) { track.stop(); });
          })
          .catch(function (err) {
            console.error('Camera access error:', err.name, err.message);
            var errorMsg = 'Ошибка доступа к камере: ' + err.name + '\n\n';

            if (err.name === 'NotAllowedError') {
              errorMsg += 'Вы не разрешили доступ к камере.\nПожалуйста, разрешите доступ и перезагрузите страницу.';
            } else if (err.name === 'NotFoundError') {
              errorMsg += 'Камера не найдена на устройстве.';
            } else if (err.name === 'NotReadableError') {
              errorMsg += 'Камера используется другим приложением.';
            } else {
              errorMsg += 'Сообщение: ' + err.message;
            }

            document.getElementById('camera-error').querySelector('p').textContent = errorMsg;
            document.getElementById('camera-error').style.display = 'flex';
            document.querySelector('.arjs-loader').style.display = 'none';
          });
      } else {
        console.error('getUserMedia not supported');
        document.getElementById('camera-error').querySelector('p').textContent = 'Ваш браузер не поддерживает доступ к камере.\nПожалуйста, используйте современный браузер (Chrome, Safari, Firefox).';
        document.getElementById('camera-error').style.display = 'flex';
        document.querySelector('.arjs-loader').style.display = 'none';
      }

      // Hide loader when scene is loaded
      var scene = document.querySelector('a-scene');
      if (scene) {
        scene.addEventListener('loaded', function () {
          var loader = document.querySelector('.arjs-loader');
          if (loader) loader.style.display = 'none';
          console.log('AR Scene loaded successfully!');
        });

        scene.addEventListener('error', function (e) {
          console.error('AR Scene error:', e);
          alert('Ошибка загрузки AR сцены: ' + e.detail);
          document.querySelector('.arjs-loader').style.display = 'none';
        });
      }

      // Log AR.js events
      window.addEventListener('arjs-video-loaded', function () {
        console.log('AR.js video loaded');
      });

      window.addEventListener('arjs-error', function (e) {
        console.error('AR.js error:', e);
        alert('Ошибка AR.js: ' + e.detail);
      });
    })();
  </script>
</body>

</html>